$(function(){var a=$("#quote-id").val();$(document).on("click","#same-for-shipping",function(a){var c=$("#shipping-user-address"),e=$("#plugin-quote-quoteform");c.length&&$(":input[name], select[name]",e).each(function(){var d=$("[name="+$(this).attr("name")+"]",c);$(a.currentTarget).prop("checked")?($(this).hasClass("state")&&$(this).is(":visible")&&$("select.state",c).html($(this).html()).parent("div").show(),d.val($(this).val()).attr("readonly",!0)):(d.val("").removeAttr("readonly"),$("select.state",
c).parent("div").hide())})});$(document).on("blur","#quote-title",function(){updateQuote(a,!1)});$(document).on("click",".remove-product",function(){var b=$(this);showConfirm("You are about to remove an item. Are you sure?",function(){$.ajax({url:$("#website_url").val()+"api/quote/products/id/"+b.data("pid"),type:"delete",data:JSON.stringify({qid:a}),dataType:"json",beforeSend:showSpinner()}).done(function(a){hideSpinner();recalculate({summary:a});b.closest("tr").remove()})})});$(document).on("click",
".quote-control",function(b){b=$(b.currentTarget);1==parseInt(b.data("sendmail"))?showMailMessageEdit(b.data("trigger"),function(b){updateQuote(a,!0,b)}):(showLoader(),updateQuote(a,!1))});$(document).on("blur",".quote-recalculate",function(b){b=$(b.currentTarget);var c=b.data("scope"),e=b.data("type"),d={qid:a,type:e,value:b.val()};switch(c){case "quote-item":var f=b.data("pid");d.value=accounting.unformat(d.value);b=_update("api/quote/products/id/"+f,d);b.done(function(a){hideSpinner();$.extend(d,
{calculateProduct:!0,productId:f,summary:a});recalculate(d)});break;case "quote-partial":b=_update("api/quote/quotes/",d),b.done(function(a){hideSpinner();$.extend(d,{summary:a});recalculate(d)})}});$(document).on("change","#quote-discount-rate",function(b){var c={qid:a,type:"taxrate",value:$(b.currentTarget).val()};_update("api/quote/quotes/",c).done(function(a){hideSpinner();$.extend(c,{summary:a});recalculate(c)})})});
var updateQuote=function(a,b,c){a={qid:a,sendMail:b,title:$("#quote-title").val(),disclaimer:$(".quote-disclaimer-text").val(),createdAt:$("#datepicker-created").val(),expiresAt:$("#datepicker-expires").val(),shipping:$("#shipping-user-address").serialize(),billing:$("#plugin-quote-quoteform").serialize(),mailMessage:b?c:""};_update("api/quote/quotes/",a).done(function(a,b,c){hideLoader();recalculate({summary:a})})},_update=function(a,b){return $.ajax({type:"put",url:$("#website_url").val()+a,dataType:"json",
data:JSON.stringify(b),beforeSend:showSpinner()})},recalculate=function(a){if(a.hasOwnProperty("calculateProduct")&&!0===a.calculateProduct){var b=$('input.price-unit[data-pid="'+a.productId+'"]'),c=parseFloat(accounting.unformat(b.val())),e=parseInt($('input.qty-unit[data-pid="'+a.productId+'"]').val()),e=c*e;$('.price-total[data-pid="'+a.productId+'"]').text(accounting.formatMoney(e));b.val(accounting.formatNumber(c,2))}a=a.summary;$(".sub-total").text(accounting.formatMoney(a.subTotal));$(".tax-total").text(accounting.formatMoney(a.totalTax));
$("#quote-shipping-price").val(accounting.formatNumber(a.shipping,2));$("#quote-discount").val(accounting.formatNumber(a.discount,2));$("#quote-tax-discount").text(accounting.formatMoney(a.discountTax));$("#quote-discount-with-tax").text(accounting.formatMoney(a.discountWithTax));$(".grand-total").text(accounting.formatMoney(a.total));$(".totalwotax-total").text(accounting.formatMoney(a.total-a.totalTax));$("#quote-shipping-with-tax").text(accounting.formatMoney(a.shippingWithTax))};
