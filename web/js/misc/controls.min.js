$(function(){var d=$("#quote-id").val();$(document).on("click","#same-for-shipping",function(a){var c=$("#shipping-user-address"),b=$("#plugin-quote-quoteform");c.length&&$(":input[name], select[name]",b).each(function(){var b=$("[name="+$(this).attr("name")+"]",c);$(a.currentTarget).prop("checked")?($(this).hasClass("state")&&$(this).is(":visible")&&$("select.state",c).html($(this).html()).parent("div").show(),b.val($(this).val()).attr("readonly",!0)):(b.val("").removeAttr("readonly"),$("select.state",
c).parent("div").hide())})});$(document).on("blur","#quote-title",function(){updateQuote(d,!1)});$(document).on("click",".remove-product",function(){var a=$(this),c=$(a).data("sid");showConfirm("You are about to remove an item. Are you sure?",function(){$.ajax({url:$("#website_url").val()+"api/quote/products/id/"+a.data("pid"),type:"delete",data:JSON.stringify({qid:d,sid:c}),dataType:"json",beforeSend:showSpinner()}).done(function(c){hideSpinner();recalculate({summary:c});a.closest("tr").remove()})})});
$(document).on("click","#add-product-to-quote",function(a){a=$(this).data("type");updateQuote(d,!1,"",a)});$(document).on("click",".quote-control",function(a){a=$(a.currentTarget);1==parseInt(a.data("sendmail"))?showMailMessageEdit(a.data("trigger"),function(a,b){updateQuote(d,!0,a,"",b)},"customer"):(a="","undefined"!==typeof $(this).data("type")&&(a=$(this).data("type")),showLoader(),updateQuote(d,!1,"",a))});$(document).on("click",".clone-quote",function(a){a=$("#page_id").val();$.ajax({url:$("#website_url").val()+
"api/quote/quotes/",type:"post",data:{type:"clone",quoteId:d,pageId:a},dataType:"json",beforeSend:showSpinner()}).done(function(a){var b='<a href="'+$("#website_url").val()+a.id+'.html" target="_blank" title="'+a.id+'">'+$("#website_url").val()+a.id+".html</a>";hideSpinner();showMessage("The quote has been duplicated. <br/>"+b,!1,15E3);recalculate({summary:a})})});$(document).on("blur",".quote-recalculate",function(a){a=$(a.currentTarget);var c=a.data("scope"),b=a.data("type"),f=$(a).data("sid"),
e=a.val();if("qty"==b){e=Math.abs(e);if(0==e)return showMessage("You can't set zero qty for product!",!0,3E3),!1;a.val(e)}else if("price"==b){e=Math.abs(e);if(0==e)return showMessage("You can't set zero price for product!",!0,3E3),!1;a.val(e)}var g={qid:d,type:b,value:e,sid:f};switch(c){case "quote-item":var h=a.data("pid");g.value=accounting.unformat(g.value);a=_update("api/quote/products/id/"+h,g);a.done(function(a){hideSpinner();$.extend(g,{calculateProduct:!0,productId:h,summary:a});recalculate(g,
f)});break;case "quote-partial":a=_update("api/quote/quotes/",g),a.done(function(a){hideSpinner();$.extend(g,{summary:a});recalculate(g,f)})}});$(document).on("change","#quote-discount-rate",function(a){var c={qid:d,type:"taxrate",value:$(a.currentTarget).val()};_update("api/quote/quotes/",c).done(function(a){hideSpinner();$.extend(c,{summary:a});recalculate(c)})});$(document).on("change",".quote-disclaimer-text",function(a){a.preventDefault();$(".quote-control-save").trigger("click");showMessage("Quote notes has been saved",
!1,3E3)})});
var processDraggable=function(d){if($("#quote-draggable-products").val()){var a=[];$(".quote-sortable-product-row").each(function(c){a.push($(this).data("sort-product-sid"))});a.length&&$.ajax({url:$("#website_url").val()+"plugin/quote/run/saveDragListOrder",data:{quoteId:d,data:a},type:"post",dataType:"json"}).done(function(a){})}return!0},updateQuote=function(d,a,c,b,f){var e=$("#plugin-quote-quoteform"),g=$("#shipping-user-address"),h=[],k=!1;"undefined"!==typeof e&&$(":input[name], select[name]",e).each(function(a,
b){$(b).hasClass("required")&&"quote-form-email"!=$(b).attr("id")&&""===$(this).val()&&h.push(b)});"undefined"!==typeof g&&$(":input[name], select[name]",g).each(function(a,b){$(b).hasClass("required")&&"email"!=$(b).attr("id")&&""===$(this).val()&&h.push(b)});h.length&&(k=!0);a={qid:d,sendMail:a,title:$("#quote-title").val(),disclaimer:$(".quote-disclaimer-text").val(),createdAt:$("#datepicker-created").val(),expiresAt:$("#datepicker-expires").val(),shipping:$("#shipping-user-address").serialize(),
billing:$("#plugin-quote-quoteform").serialize(),mailMessage:a?c:"",errorMessage:k,eventType:b?b:"",ccEmails:f};_update("api/quote/quotes/",a).done(function(a,b,c){hideLoader();if(1==a.error)return showMessage(a.responseText,!0,5E3),!1;processDraggable(d);recalculate({summary:a})})},_update=function(d,a){return $.ajax({type:"put",url:$("#website_url").val()+d,dataType:"json",data:JSON.stringify(a),beforeSend:showSpinner()})},recalculate=function(d,a){var c={};1==$("#quote-us-numeric-format").val()&&
(c={symbol:$("#quote-currency").val(),thousand:",",decimal:"."});if(d.hasOwnProperty("calculateProduct")&&!0===d.calculateProduct){if(a.length)var b=$('input.price-unit[data-sid="'+a+'"]'),f=parseInt($('input.qty-unit[data-sid="'+a+'"]').val());else b=$('input.price-unit[data-pid="'+d.productId+'"]'),f=parseInt($('input.qty-unit[data-pid="'+d.productId+'"]').val());var e=parseFloat(accounting.unformat(b.val())),f=e*f;a.length?$('.price-total[data-sid="'+a+'"]').text(accounting.formatMoney(f,c)):$('.price-total[data-pid="'+
d.productId+'"]').text(accounting.formatMoney(f,c));b.val(accounting.formatNumber(e,2))}b=d.summary;$(".sub-total").text(accounting.formatMoney(b.subTotal,c));$(".tax-total").text(accounting.formatMoney(b.totalTax,c));$("#quote-shipping-price").val(accounting.formatNumber(b.shipping,2));$("#quote-discount").val(accounting.formatNumber(b.discount,2));$("#quote-tax-discount").text(accounting.formatMoney(b.discountTax,c));$("#quote-discount-with-tax").text(accounting.formatMoney(b.discountWithTax,c));
$(".grand-total").text(accounting.formatMoney(b.total,c));$(".totalwotax-total").text(accounting.formatMoney(b.total-b.totalTax,c));$("#quote-shipping-with-tax").text(accounting.formatMoney(b.shippingWithTax,c))};
