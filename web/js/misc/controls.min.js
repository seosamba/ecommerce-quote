$(function(){var b=$("#quote-id").val(),c=$(".tpopup.edit-page-link");c.length&&$(c).addClass("hidden");var e=$("#del-this-page");e.length&&$(e).addClass("hidden");c.length&&e.length&&(c=$("#page_id").val(),$.ajax({url:$("#website_url").val()+"plugin/quote/run/showEditQuotePageConfig",type:"POST",data:{pageId:c},dataType:"json"}).done(function(a){$(".page-control").closest("ul li:nth-child(1)").after($("<li>").append(a.responseText.quotePageConfig))}));setTimeout(function(){calculateSubtotals()},
1E3);$(document).on("click","#same-for-shipping",function(a){var b=$("#shipping-user-address"),c=$("#plugin-quote-quoteform");b.length&&$(":input[name], select[name]",c).each(function(){var c=$("[name="+$(this).attr("name")+"]",b);$(a.currentTarget).prop("checked")?($(this).hasClass("state")&&$(this).is(":visible")&&$("select.state",b).html($(this).html()).parent("div").show(),c.val($(this).val()).attr("readonly",!0)):(c.val("").removeAttr("readonly"),$("select.state",b).parent("div").hide())})});
$(document).on("blur","#quote-title",function(){updateQuote(b,!1)});$(document).on("change",".quote-info",function(a){a=$(a.originalEvent);var d=0,c=0;if($(this).closest(".quote-info").hasClass("allow-auto-save")){$(this).closest(".quote-info").hasClass("disable-autosave-email")&&(c=1);if("undefined"!==typeof $(a).get(0)&&("quote-form-email"==$(a).get(0).target.id||"email"==$(a).get(0).target.id)){var d=1,e=$(a).get(0).target.defaultValue;"undefined"!==typeof e&&""!==e&&$("#"+$(a).get(0).target.id).attr("data-email",
e);if(c)return!1}updateQuote(b,!1,"","","",!0,d,c)}});$(document).on("click",".use-lead-address",function(a){a.preventDefault();if($(this).closest(".quote-info").hasClass("allow-auto-save")){var d=$(this).data("type");showConfirm("Would you like to refresh the quote "+d+" address with lead address?",function(){$.ajax({url:$("#website_url").val()+"plugin/quote/run/useLeadAddress",data:{quoteId:b,addressType:d},type:"post",dataType:"json"}).done(function(a){if("1"==a.error)return showMessage(a.responseText,
!0,5E3),!1;showMessage(a.responseText,!1,3E3);window.setTimeout(function(){window.location.reload()},2E3)})})}});$(document).on("change","#overwrite-quote-user-shipping",function(){$(this).is(":checked")?$("#overwrite-quote-user-billing").prop("checked",!1):$("#overwrite-quote-user-billing").prop("checked",!0)});$(document).on("click",".remove-product",function(){var a=$(this),d=$(a).data("sid");showConfirm("You are about to remove an item. Are you sure?",function(){$.ajax({url:$("#website_url").val()+
"api/quote/products/id/"+a.data("pid"),type:"delete",data:JSON.stringify({qid:b,sid:d}),dataType:"json",beforeSend:showSpinner()}).done(function(b){hideSpinner();recalculate({summary:b});a.closest("tr").remove();calculateSubtotals()})})});$(document).on("click","#add-product-to-quote",function(a){a=$(this).data("type");updateQuote(b,!1,"",a)});$(document).on("click",".quote-control",function(a){var d=$(a.currentTarget);if("disabled"!==$("#quote-payment-type-selector").attr("disabled")&&"partial_payment"===
$("#quote-payment-type-selector").val()&&(1>parseInt($("#partial-payment-percentage").val())||isNaN(parseInt($("#partial-payment-percentage").val()))))return showMessage("Please specify partial payment amount",!0,5E3),hideLoader(),!1;1==parseInt(d.data("sendmail"))?$.ajax({url:$("#website_url").val()+"plugin/quote/run/checkquoteExpired/",type:"post",data:{quoteId:b},dataType:"json",beforeSend:showSpinner()}).done(function(a){if("1"==a.error)return showMessage(a.responseText,!0,5E3),!1;showMailMessageEditQuote(d.data("trigger"),
function(a,d,c){updateQuote(b,!0,a,"",d,!1,"","",c)},"customer")}):(a="","undefined"!==typeof $(this).data("type")&&(a=$(this).data("type")),showLoader(),updateQuote(b,!1,"",a))});$(document).on("click",".clone-quote",function(a){a=$("#page_id").val();$.ajax({url:$("#website_url").val()+"api/quote/quotes/",type:"post",data:{type:"clone",quoteId:b,pageId:a},dataType:"json",beforeSend:showSpinner()}).done(function(a){var b='<a href="'+$("#website_url").val()+a.id+'.html" target="_blank" title="'+a.id+
'">'+$("#website_url").val()+a.id+".html</a>";hideSpinner();showMessage("The quote has been duplicated. <br/>"+b,!1,15E3);recalculate({summary:a})})});$(document).on("blur",".quote-recalculate",function(a){a=$(a.currentTarget);var d=a.data("scope"),c=a.data("type"),e=$(a).data("sid"),f=a.val();if("qty"==c){f=Math.abs(f);if(0==f)return showMessage("You can't set zero qty for product!",!0,3E3),!1;a.val(f)}else if("price"==c){f=Math.abs(f);if(0==f)return showMessage("You can't set zero price for product!",
!0,3E3),!1;a.val(f)}var g={qid:b,type:c,value:f,sid:e};switch(d){case "quote-item":var h=a.data("pid");g.value=accounting.unformat(g.value);a=_update("api/quote/products/id/"+h,g,!1);a.done(function(a){hideSpinner();$.extend(g,{calculateProduct:!0,productId:h,summary:a});recalculate(g,e)});break;case "quote-partial":a=_update("api/quote/quotes/",g,!1),a.done(function(a){hideSpinner();$.extend(g,{summary:a});recalculate(g,e)})}});$(document).on("change","#quote-discount-rate",function(a){var d={qid:b,
type:"taxrate",value:$(a.currentTarget).val()};_update("api/quote/quotes/",d,!1).done(function(a){hideSpinner();$.extend(d,{summary:a});recalculate(d)})});$(document).on("change",".quote-disclaimer-text",function(a){a.preventDefault();$(".quote-control-save").trigger("click");showMessage("Quote notes has been saved",!1,3E3)});$(document).on("keyup","#partial-payment-percentage",function(a){a.preventDefault();var d={qid:b,type:"taxrate",value:$(a.currentTarget).val()};updateQuote(b,!1,"");_update("api/quote/quotes/",
d,!1).done(function(a){hideSpinner();$.extend(d,{summary:a});recalculate(d)})});$(document).on("change","#partial-payment-type",function(a){a.preventDefault();var d={qid:b,type:"taxrate",value:$(a.currentTarget).val()};updateQuote(b,!1,"");_update("api/quote/quotes/",d,!1).done(function(a){hideSpinner();$.extend(d,{summary:a});recalculate(d)})});$(document).on("change","#quote-payment-type-selector",function(a){a=$(a.currentTarget).val();var b=0;$("#quote-signature-required").is(":checked")&&(b=1);
"only_signature"===a?$("#quote-signature-required").prop("disabled",!0).prop("checked",!0):$("#quote-signature-required").prop("disabled",!1);"partial_payment"===a?$("#mark-first-payment-paid-block").removeClass("hidden"):$("#mark-first-payment-paid-block").addClass("hidden");changePaymentTypeMessage(a,b)});$(document).on("change","#quote-signature-required",function(a){a=$("#quote-payment-type-selector").val();var b=0;$("#quote-signature-required").is(":checked")?(b=1,$("#quote-signature-block").removeClass("hidden")):
$("#quote-signature-block").addClass("hidden");changePaymentTypeMessage(a,b)});$("#quote-draggable-products").val()&&($("#quote-sortable").sortable({deactivate:function(a,c){processDraggable(b)}}),c=!1,$("#quote-sortable").length&&(c=$(".quote-sortable-product-row").find("td"),c.length&&$(c).each(function(a,b){$(b).hasClass("product-unit-price")||$(b).hasClass("product-qty")||$(b).addClass("sortable-handle")}),c=!0),c&&$("#quote-sortable").sortable("option","handle",".sortable-handle"));$(document).on("change",
"#is-partial-payment-payed",function(a){var c=$(this);a=$("#confirm-message-for-first-payment-checked").text();var e=!1;c.is(":checked")&&(a=$("#confirm-message-for-first-payment-not-checked").text()+" "+$("#partial-payment-percentage-payment-amount").text()+" "+$("#confirm-message-for-first-payment-not-checked-second-part").text(),e=!0);showConfirm(a,function(){$.ajax({url:$("#website_url").val()+"api/quote/partialpayment/",type:"POST",data:{quoteId:b,partialPercentage:$("#partial-payment-percentage").val(),
partialType:$("#partial-payment-type").val()},dataType:"json",beforeSend:showSpinner()}).done(function(a){hideSpinner();showMessage(a.responseText.generalSuccess,!0,3E3);window.setTimeout(function(){window.location.reload()},2E3);return!1}).fail(function(a){showMessage(JSON.parse(a.responseText),!0,5E3);!0===e?c.prop("checked",!1):c.prop("checked",!0)})},function(){!0===e?c.prop("checked",!1):c.prop("checked",!0)})});getLeadLink(b);getDisableEmailAutosave();$(document).on("change",".custom-field-element",
function(a){a.preventDefault();a=$("#cart-id").val();var b=$(this).val(),c=$(this).data("type"),e=$(this).data("field-id");$.ajax({type:"POST",url:$("#website_url").val()+"plugin/quote/run/updateCustomfield",data:{cartId:a,customFieldValue:b,customFieldType:c,customFieldId:e}}).done(function(a){if("1"==a.error)return showMessage(a.responseText,!0,3E3),!1})})});
var getLeadLink=function(b){$.ajax({url:$("#website_url").val()+"plugin/quote/run/getLeadLink",data:{quoteId:b},type:"post",dataType:"json"}).done(function(b){$(".lead-link").remove();b.responseText.link&&(b='<a target="_blank" class="lead-link icon-link fl-right grid_7 alpha icon-profile" title="Go to CRM Lead" href="'+b.responseText.link+'"></a>',$("#quote-form-email").closest("p").find("label").append(b))})},getDisableEmailAutosave=function(){$(".quote-info").hasClass("allow-auto-save")&&$(".quote-info").hasClass("disable-autosave-email")&&
($(".disable-email-autosave").remove(),$("#quote-form-email").closest("p").find("label").append('<a href="javascript:;" class="disable-email-autosave ticon-info tooltip icon18 fl-right grid_8" title="Email won\'t be saved automatically, please turn off (Disable email autosave) in config or Save the quote manually"></a>'),$("#email").closest("p").find("label").append('<a href="javascript:;" class="disable-email-autosave ticon-info tooltip icon18 fl-right grid_8" title="Email won\'t be saved automatically, please turn off (Disable email autosave) in config or Save the quote manually"></a>'))},
processDraggable=function(b){if($("#quote-draggable-products").val()){var c=[];$(".quote-sortable-product-row").each(function(b){c.push($(this).data("sort-product-sid"))});c.length&&$.ajax({url:$("#website_url").val()+"plugin/quote/run/saveDragListOrder",data:{quoteId:b,data:c},type:"post",dataType:"json"}).done(function(b){calculateSubtotals()})}return!0},updateQuote=function(b,c,e,a,d,m,k,f,g){var h=$("#plugin-quote-quoteform"),l=$("#shipping-user-address"),n=[],p=!1;"undefined"===typeof m&&(m=
!1);"undefined"!==typeof h&&$(":input[name], select[name]",h).each(function(a,b){$(b).hasClass("required")&&"quote-form-email"!=$(b).attr("id")&&"state"!=$(b).attr("id")&&""===$(this).val()&&n.push(b)});"undefined"!==typeof l&&$(":input[name], select[name]",l).each(function(a,b){$(b).hasClass("required")&&"email"!=$(b).attr("id")&&"state"!=$(b).attr("id")&&""===$(this).val()&&n.push(b)});n.length&&(p=!0);h=0;$("#quote-signature-required").is(":checked")&&(h=1);f&&(f=$("#quote-form-email").data("email"),
l=$("#email").data("email"),"undefined"!==typeof f&&""!==f&&$("#quote-form-email").val(f),"undefined"!==typeof l&&""!==l&&$("#email").val(l));c={qid:b,sendMail:c,title:$("#quote-title").val(),disclaimer:$(".quote-disclaimer-text").val(),createdAt:$("#datepicker-created").val(),expiresAt:$("#datepicker-expires").val(),shipping:$("#shipping-user-address").serialize(),billing:$("#plugin-quote-quoteform").serialize(),mailMessage:c?e:"",errorMessage:p,eventType:a?a:"",paymentType:$("#quote-payment-type-selector").val(),
isSignatureRequired:h,partialPaymentPercentage:$("#partial-payment-percentage").val(),partialPaymentType:$("#partial-payment-type").val(),ccEmails:d,additionalEmailValidate:k?k:"",additionalInfo:g,enableShippingMandatory:$("#enable-shipping-custom-validation").val(),enableBillingMandatory:$("#enable-billing-custom-validation").val(),shippingMandatoryFields:$("#enable-shipping-custom-validation").data("mandatory-fields"),billingMandatoryFields:$("#enable-billing-custom-validation").data("mandatory-fields")};
_update("api/quote/quotes/",c,m).done(function(a,c,d){hideLoader();if(1==a.error)return showMessage(a.responseText,!0,5E3),!1;0==a.error&&a.responseText&&showMessage(a.responseText,!1,3E3);!$(".quote-info").hasClass("allow-auto-save")&&a.allowAutosave&&($(".quote-info").addClass("allow-auto-save"),getDisableEmailAutosave(),!$(".quote-info").hasClass("disable-autosave-email")&&a.disableAutosaveEmail&&$(".quote-info").addClass("disable-autosave-email"),c=$("#quote-form-email").val(),d=$("#email").val(),
"undefined"!==typeof c&&""!==c&&$("#quote-form-email").attr("data-email",c),"undefined"!==typeof d&&""!==d&&$("#email").attr("data-email",d));getLeadLink(b);processDraggable(b);recalculate({summary:a})})},_update=function(b,c,e){return $.ajax({type:"put",url:$("#website_url").val()+b,dataType:"json",data:JSON.stringify(c),beforeSend:e?"":showSpinner()})},recalculate=function(b,c){if(b.hasOwnProperty("calculateProduct")&&!0===b.calculateProduct){if(c.length)var e=$('input.price-unit[data-sid="'+c+
'"]'),a=parseInt($('input.qty-unit[data-sid="'+c+'"]').val());else e=$('input.price-unit[data-pid="'+b.productId+'"]'),a=parseInt($('input.qty-unit[data-pid="'+b.productId+'"]').val());var d=parseFloat(accounting.unformat(e.val())),a=d*a;c.length?$('.price-total[data-sid="'+c+'"]').text(accounting.formatMoney(a,accounting.settings.currency)):$('.price-total[data-pid="'+b.productId+'"]').text(accounting.formatMoney(a,accounting.settings.currency));e.val(accounting.formatNumber(d,2))}d=b.summary;$(".sub-total").text(accounting.formatMoney(d.subTotal,
accounting.settings.currency));$(".tax-total").text(accounting.formatMoney(d.totalTax,accounting.settings.currency));$("#quote-shipping-price").val(accounting.formatNumber(d.shipping,2));$("#quote-discount").val(accounting.formatNumber(d.discount,2));$("#quote-tax-discount").text(accounting.formatMoney(d.discountTax,accounting.settings.currency));$("#quote-discount-with-tax").text(accounting.formatMoney(d.discountWithTax,accounting.settings.currency));$(".grand-total").text(accounting.formatMoney(d.total,
accounting.settings.currency));$(".totalwotax-total").text(accounting.formatMoney(d.total-d.totalTax,accounting.settings.currency));$("#quote-shipping-with-tax").text(accounting.formatMoney(d.shippingWithTax,accounting.settings.currency));0<$("#partial-payment-percentage").length&&(e=$("#partial-payment-percentage").val(),d=accounting.formatMoney(e*d.total/100),"amount"===$("#partial-payment-type").val()?(d=accounting.formatMoney(e),$("#percentage-amount-text").addClass("hidden")):$("#percentage-amount-text").removeClass("hidden"),
$("#partial-payment-percentage-payment-amount").html(d));calculateSubtotals()};
function changePaymentTypeMessage(b,c){"only_signature"===b?$("#quote-type-info-message").addClass("hidden"):$.ajax({url:$("#website_url").val()+"plugin/quote/run/getPaymenttypeinfo",type:"POST",data:{quoteId:$("#quote-id-payment-type").val(),paymentType:b,isSignatureRequired:c},dataType:"json",beforeSend:showSpinner()}).done(function(c){hideSpinner();if("0"==c.error&&($("#quote-type-info-message").html(c.responseText),$("#quote-type-info-message").removeClass("hidden"),"partial_payment"===b)){var a=
{qid:$("#quote-id-payment-type").val(),type:"taxrate",value:$("#partial-payment-percentage").val()};_update("api/quote/quotes/",a,!1).done(function(b){hideSpinner();$.extend(a,{summary:b});recalculate(a)})}}).fail(function(b){showMessage(JSON.parse(b.responseText),!0,5E3)})}
function showMailMessageEditQuote(b,c,e){$.getJSON($("#website_url").val()+"plugin/quote/run/popupEmailMessage",{trigger:b,recipient:e},function(a){$(g).remove();var b=a.responseText.message,e=a.responseText.dialogTitle,k=a.responseText.dialogOkay,f={},e=0<e.length?e:"Edit mail message before sending",k=0<k.length?k:"Okay",b=b?a.responseText.message:"success",g=$('<div class="msg-edit-screen"></div>').append($('<textarea id="trigger-msg" rows="10"></textarea>').val(b).css({resizable:"none"}));$(g).append(a.responseText.popupContent);
$("#trigger-msg").val(b);g.dialog({modal:!0,title:e,width:600,resizable:!1,show:"clip",hide:"clip",draggable:!1,open:function(a,b){$(document).on("change","#process-opportunity",function(){$(this).is(":checked")?$(document).find(".opportunity-processing-block").removeClass("hidden"):$(document).find(".opportunity-processing-block").addClass("hidden")})},buttons:[{text:k,click:function(b){b=$("#additional-emails").val();var d=!0;if(b.length){b=b.split(",");var e=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
$.each(b,function(a,b){var c=b.toString().replace(/\s/g,"");e.test(c)||(d=!1,showMessage('Not valid email address - "'+c+'"',!0,3E3))})}if(d){f.processOpportunity="0";$("#process-opportunity").is(":checked")&&(f.processOpportunity="1");f.reprocessOpportunity="0";$("#re-process-opportunity").is(":checked")&&(f.reprocessOpportunity="1");f.stageId=$("#email-opportunity-stage-id").val();if("0"==f.stageId&&"1"==f.processOpportunity)return showMessage(a.responseText.errorMessages.specifyOpportunityStage,
!0,5E3),!1;g.dialog("close");c($("#trigger-msg").val(),$("#additional-emails").val(),f)}}}],close:function(a,b){$(this).dialog("close").remove()}})},"json")}
function parsePrice(b){if(!b)return 0;b=b.toString().trim();b=b.replace(/[\u00A0\u202F]/g,"");b=b.replace(/[^0-9.,-]/g,"");var c=(b.match(/,/g)||[]).length,e=(b.match(/\./g)||[]).length;return/^\d{1,3}(,\d{3})+\.\d+$/.test(b)?(b=b.replace(/,/g,""),parseFloat(b)):/^\d{1,3}(\.\d{3})+,\d+$/.test(b)?(b=b.replace(/\./g,"").replace(",","."),parseFloat(b)):1<c?(b=b.replace(/,/g,""),parseFloat(b)):1<e?(b=b.replace(/\./g,""),parseFloat(b)):1===c&&1===e?(b=b.indexOf(",")>b.indexOf(".")?b.replace(/\./g,"").replace(",",
"."):b.replace(/,/g,""),parseFloat(b)):1===c&&0===e?(b=b.replace(",","."),parseFloat(b)):1===e&&0===c?parseFloat(b):parseFloat(b)||0}
function calculateSubtotals(){var b=0;document.querySelectorAll(".quote-subtotal-row").forEach(function(c){var e=c.querySelector(".price-total");if(e)c=e.textContent.trim(),c=parsePrice(c),b+=c;else if(c.classList.contains("quote-subtotal-row-")){if(c=c.querySelector(".price-sub-total .prepop-text")){if((e=document.getElementById("custom-sub-total-currency"))&&e.value.trim()){var a=Object.assign({},accounting.settings.currency);a.symbol=e.value.trim();c.value=accounting.formatMoney(b,a)}else c.value=
accounting.formatMoney(b,accounting.settings.currency);c.dispatchEvent(new Event("blur",{bubbles:!0}))}b=0}})};
