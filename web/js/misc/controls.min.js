$(function(){var c=$("#quote-id").val();$(document).on("click","#same-for-shipping",function(a){var b=$("#shipping-user-address"),d=$("#plugin-quote-quoteform");b.length&&$(":input[name], select[name]",d).each(function(){var d=$("[name="+$(this).attr("name")+"]",b);$(a.currentTarget).prop("checked")?($(this).hasClass("state")&&$(this).is(":visible")&&$("select.state",b).html($(this).html()).parent("div").show(),d.val($(this).val()).attr("readonly",!0)):(d.val("").removeAttr("readonly"),$("select.state",
b).parent("div").hide())})});$(document).on("blur","#quote-title",function(){updateQuote(c,!1)});$(document).on("click",".remove-product",function(){var a=$(this),b=$(a).data("sid");showConfirm("You are about to remove an item. Are you sure?",function(){$.ajax({url:$("#website_url").val()+"api/quote/products/id/"+a.data("pid"),type:"delete",data:JSON.stringify({qid:c,sid:b}),dataType:"json",beforeSend:showSpinner()}).done(function(b){hideSpinner();recalculate({summary:b});a.closest("tr").remove()})})});
$(document).on("click","#add-product-to-quote",function(a){a=$(this).data("type");updateQuote(c,!1,"",a)});$(document).on("click",".quote-control",function(a){a=$(a.currentTarget);if("partial_payment"===$("#quote-payment-type-selector").val()&&(1>parseInt($("#partial-payment-percentage").val())||isNaN(parseInt($("#partial-payment-percentage").val()))))return showMessage("Please specify partial payment percentage",!0,5E3),hideLoader(),!1;1==parseInt(a.data("sendmail"))?showMailMessageEdit(a.data("trigger"),
function(a,d){updateQuote(c,!0,a,"",d)},"customer"):(a="","undefined"!==typeof $(this).data("type")&&(a=$(this).data("type")),showLoader(),updateQuote(c,!1,"",a))});$(document).on("click",".clone-quote",function(a){a=$("#page_id").val();$.ajax({url:$("#website_url").val()+"api/quote/quotes/",type:"post",data:{type:"clone",quoteId:c,pageId:a},dataType:"json",beforeSend:showSpinner()}).done(function(a){var d='<a href="'+$("#website_url").val()+a.id+'.html" target="_blank" title="'+a.id+'">'+$("#website_url").val()+
a.id+".html</a>";hideSpinner();showMessage("The quote has been duplicated. <br/>"+d,!1,15E3);recalculate({summary:a})})});$(document).on("blur",".quote-recalculate",function(a){a=$(a.currentTarget);var b=a.data("scope"),d=a.data("type"),h=$(a).data("sid"),f=a.val();if("qty"==d){f=Math.abs(f);if(0==f)return showMessage("You can't set zero qty for product!",!0,3E3),!1;a.val(f)}else if("price"==d){f=Math.abs(f);if(0==f)return showMessage("You can't set zero price for product!",!0,3E3),!1;a.val(f)}var g=
{qid:c,type:d,value:f,sid:h};switch(b){case "quote-item":var k=a.data("pid");g.value=accounting.unformat(g.value);a=_update("api/quote/products/id/"+k,g);a.done(function(a){hideSpinner();$.extend(g,{calculateProduct:!0,productId:k,summary:a});recalculate(g,h)});break;case "quote-partial":a=_update("api/quote/quotes/",g),a.done(function(a){hideSpinner();$.extend(g,{summary:a});recalculate(g,h)})}});$(document).on("change","#quote-discount-rate",function(a){var b={qid:c,type:"taxrate",value:$(a.currentTarget).val()};
_update("api/quote/quotes/",b).done(function(a){hideSpinner();$.extend(b,{summary:a});recalculate(b)})});$(document).on("change",".quote-disclaimer-text",function(a){a.preventDefault();$(".quote-control-save").trigger("click");showMessage("Quote notes has been saved",!1,3E3)});$(document).on("keyup","#partial-payment-percentage",function(a){a.preventDefault();var b={qid:c,type:"taxrate",value:$(a.currentTarget).val()};_update("api/quote/quotes/",b).done(function(a){hideSpinner();$.extend(b,{summary:a});
recalculate(b)})});$(document).on("change","#quote-payment-type-selector",function(a){a=$(a.currentTarget).val();var b=0;$("#quote-signature-required").is(":checked")&&(b=1);"only_signature"===a?$("#quote-signature-required").prop("disabled",!0).prop("checked",!0):$("#quote-signature-required").prop("disabled",!1);changePaymentTypeMessage(a,b)});$(document).on("change","#quote-signature-required",function(a){a=$("#quote-payment-type-selector").val();var b=0;$("#quote-signature-required").is(":checked")&&
(b=1);changePaymentTypeMessage(a,b)})});
var processDraggable=function(c){if($("#quote-draggable-products").val()){var a=[];$(".quote-sortable-product-row").each(function(b){a.push($(this).data("sort-product-sid"))});a.length&&$.ajax({url:$("#website_url").val()+"plugin/quote/run/saveDragListOrder",data:{quoteId:c,data:a},type:"post",dataType:"json"}).done(function(a){})}return!0},updateQuote=function(c,a,b,d,h){var f=$("#plugin-quote-quoteform"),g=$("#shipping-user-address"),k=[],l=!1;"undefined"!==typeof f&&$(":input[name], select[name]",
f).each(function(a,b){$(b).hasClass("required")&&"quote-form-email"!=$(b).attr("id")&&""===$(this).val()&&k.push(b)});"undefined"!==typeof g&&$(":input[name], select[name]",g).each(function(a,b){$(b).hasClass("required")&&"email"!=$(b).attr("id")&&""===$(this).val()&&k.push(b)});k.length&&(l=!0);f=0;$("#quote-signature-required").is(":checked")&&(f=1);a={qid:c,sendMail:a,title:$("#quote-title").val(),disclaimer:$(".quote-disclaimer-text").val(),createdAt:$("#datepicker-created").val(),expiresAt:$("#datepicker-expires").val(),
shipping:$("#shipping-user-address").serialize(),billing:$("#plugin-quote-quoteform").serialize(),mailMessage:a?b:"",errorMessage:l,eventType:d?d:"",paymentType:$("#quote-payment-type-selector").val(),pdfTemplate:$("#quote-pdf-template-selector").val(),isSignatureRequired:f,partialPaymentPercentage:$("#partial-payment-percentage").val(),ccEmails:h};_update("api/quote/quotes/",a).done(function(a,b,d){hideLoader();if(1==a.error)return showMessage(a.responseText,!0,5E3),!1;processDraggable(c);recalculate({summary:a})})},
_update=function(c,a){return $.ajax({type:"put",url:$("#website_url").val()+c,dataType:"json",data:JSON.stringify(a),beforeSend:showSpinner()})},recalculate=function(c,a){if(c.hasOwnProperty("calculateProduct")&&!0===c.calculateProduct){if(a.length)var b=$('input.price-unit[data-sid="'+a+'"]'),d=parseInt($('input.qty-unit[data-sid="'+a+'"]').val());else b=$('input.price-unit[data-pid="'+c.productId+'"]'),d=parseInt($('input.qty-unit[data-pid="'+c.productId+'"]').val());var h=parseFloat(accounting.unformat(b.val())),
d=h*d;a.length?$('.price-total[data-sid="'+a+'"]').text(accounting.formatMoney(d)):$('.price-total[data-pid="'+c.productId+'"]').text(accounting.formatMoney(d));b.val(accounting.formatNumber(h,2))}b=c.summary;$(".sub-total").text(accounting.formatMoney(b.subTotal));$(".tax-total").text(accounting.formatMoney(b.totalTax));$("#quote-shipping-price").val(accounting.formatNumber(b.shipping,2));$("#quote-discount").val(accounting.formatNumber(b.discount,2));$("#quote-tax-discount").text(accounting.formatMoney(b.discountTax));
$("#quote-discount-with-tax").text(accounting.formatMoney(b.discountWithTax));$(".grand-total").text(accounting.formatMoney(b.total));$(".totalwotax-total").text(accounting.formatMoney(b.total-b.totalTax));$("#quote-shipping-with-tax").text(accounting.formatMoney(b.shippingWithTax));0<$("#partial-payment-percentage").length&&(h=$("#partial-payment-percentage").val(),b=accounting.formatMoney(h*b.total/100),$("#partial-payment-percentage-payment-amount").html(b))};
function changePaymentTypeMessage(c,a){"only_signature"===c?$("#quote-type-info-message").addClass("hidden"):$.ajax({url:$("#website_url").val()+"plugin/quote/run/getPaymenttypeinfo",type:"POST",data:{quoteId:$("#quote-id-payment-type").val(),paymentType:c,isSignatureRequired:a},dataType:"json",beforeSend:showSpinner()}).done(function(a){hideSpinner();if("0"==a.error&&($("#quote-type-info-message").html(a.responseText),$("#quote-type-info-message").removeClass("hidden"),"partial_payment"===c)){var d=
{qid:quoteId,type:"taxrate",value:$(e.currentTarget).val()};_update("api/quote/quotes/",d).done(function(a){hideSpinner();$.extend(d,{summary:a});recalculate(d)})}}).fail(function(a){showMessage(JSON.parse(a.responseText),!0,5E3)})};
