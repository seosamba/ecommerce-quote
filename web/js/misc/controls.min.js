$(function(){var c=$("#quote-id").val();$(document).on("click","#same-for-shipping",function(a){var b=$("#shipping-user-address"),c=$("#plugin-quote-quoteform");b.length&&$(":input[name], select[name]",c).each(function(){var c=$("[name="+$(this).attr("name")+"]",b);$(a.currentTarget).prop("checked")?($(this).hasClass("state")&&$(this).is(":visible")&&$("select.state",b).html($(this).html()).parent("div").show(),c.val($(this).val()).attr("readonly",!0)):(c.val("").removeAttr("readonly"),$("select.state",
b).parent("div").hide())})});$(document).on("blur","#quote-title",function(){updateQuote(c,!1)});$(document).on("click",".remove-product",function(){var a=$(this),b=$(a).data("sid");showConfirm("You are about to remove an item. Are you sure?",function(){$.ajax({url:$("#website_url").val()+"api/quote/products/id/"+a.data("pid"),type:"delete",data:JSON.stringify({qid:c,sid:b}),dataType:"json",beforeSend:showSpinner()}).done(function(b){hideSpinner();recalculate({summary:b});a.closest("tr").remove()})})});
$(document).on("click","#add-product-to-quote",function(a){updateQuote(c,!1)});$(document).on("click",".quote-control",function(a){a=$(a.currentTarget);1==parseInt(a.data("sendmail"))?showMailMessageEdit(a.data("trigger"),function(b){updateQuote(c,!0,b)},"customer"):(showLoader(),updateQuote(c,!1))});$(document).on("click",".clone-quote",function(a){$.ajax({url:$("#website_url").val()+"api/quote/quotes/",type:"post",data:{type:"clone",quoteId:c},dataType:"json",beforeSend:showSpinner()}).done(function(b){var a=
'<a href="'+$("#website_url").val()+b.id+'.html" target="_blank" title="'+b.id+'">'+$("#website_url").val()+b.id+".html</a>";hideSpinner();showMessage("The quote has been duplicated. <br/>"+a,!1,15E3);recalculate({summary:b})})});$(document).on("blur",".quote-recalculate",function(a){a=$(a.currentTarget);var b=a.data("scope"),e=a.data("type"),f=$(a).data("sid"),d={qid:c,type:e,value:a.val(),sid:f};switch(b){case "quote-item":var g=a.data("pid");d.value=accounting.unformat(d.value);a=_update("api/quote/products/id/"+
g,d);a.done(function(a){hideSpinner();$.extend(d,{calculateProduct:!0,productId:g,summary:a});recalculate(d,f)});break;case "quote-partial":a=_update("api/quote/quotes/",d),a.done(function(a){hideSpinner();$.extend(d,{summary:a});recalculate(d,f)})}});$(document).on("change","#quote-discount-rate",function(a){var b={qid:c,type:"taxrate",value:$(a.currentTarget).val()};_update("api/quote/quotes/",b).done(function(a){hideSpinner();$.extend(b,{summary:a});recalculate(b)})})});
var updateQuote=function(c,a,b){c={qid:c,sendMail:a,title:$("#quote-title").val(),disclaimer:$(".quote-disclaimer-text").val(),createdAt:$("#datepicker-created").val(),expiresAt:$("#datepicker-expires").val(),shipping:$("#shipping-user-address").serialize(),billing:$("#plugin-quote-quoteform").serialize(),mailMessage:a?b:""};_update("api/quote/quotes/",c).done(function(a,b,c){hideLoader();if(1==a.error)return showMessage(a.responseText,!0,5E3),!1;recalculate({summary:a})})},_update=function(c,a){return $.ajax({type:"put",
url:$("#website_url").val()+c,dataType:"json",data:JSON.stringify(a),beforeSend:showSpinner()})},recalculate=function(c,a){if(c.hasOwnProperty("calculateProduct")&&!0===c.calculateProduct){if(a.length)var b=$('input.price-unit[data-sid="'+a+'"]'),e=parseInt($('input.qty-unit[data-sid="'+a+'"]').val());else b=$('input.price-unit[data-pid="'+c.productId+'"]'),e=parseInt($('input.qty-unit[data-pid="'+c.productId+'"]').val());var f=parseFloat(accounting.unformat(b.val())),e=f*e;a.length?$('.price-total[data-sid="'+
a+'"]').text(accounting.formatMoney(e)):$('.price-total[data-pid="'+c.productId+'"]').text(accounting.formatMoney(e));b.val(accounting.formatNumber(f,2))}b=c.summary;$(".sub-total").text(accounting.formatMoney(b.subTotal));$(".tax-total").text(accounting.formatMoney(b.totalTax));$("#quote-shipping-price").val(accounting.formatNumber(b.shipping,2));$("#quote-discount").val(accounting.formatNumber(b.discount,2));$("#quote-tax-discount").text(accounting.formatMoney(b.discountTax));$("#quote-discount-with-tax").text(accounting.formatMoney(b.discountWithTax));
$(".grand-total").text(accounting.formatMoney(b.total));$(".totalwotax-total").text(accounting.formatMoney(b.total-b.totalTax));$("#quote-shipping-with-tax").text(accounting.formatMoney(b.shippingWithTax))};
