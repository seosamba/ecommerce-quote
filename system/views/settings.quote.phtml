<?php
    $this->placeholder('headerContent')->set($this->translate('Quote system settings'));
?>
<div id="quote-settings" class="ui-widget clearfix">
    <form id="quote-settings-info" enctype="application/x-www-form-urlencoded" method="post" class="quote-settings _fajax" action="<?php echo $this->form->getAction();?>">
        <?php $enableQuoteDefaultType = Models_Mapper_ShoppingConfig::getInstance()->getConfigParam('enableQuoteDefaultType');?>
        <?php $quotePaymentType = Models_Mapper_ShoppingConfig::getInstance()->getConfigParam('quotePaymentType');?>
        <?php $displayPartialPaymentNotificationClass = 'hidden';?>
        <?php $displayPartialPercentagePaymentNotificationClass = 'hidden';?>
        <?php if (!empty($enableQuoteDefaultType)):?>
            <?php $displayPartialPaymentNotificationClass = '';?>
        <?php endif;?>
        <?php if (!empty($enableQuoteDefaultType) && ($quotePaymentType === Quote_Models_Model_Quote::PAYMENT_TYPE_PARTIAL_PAYMENT || $quotePaymentType === Quote_Models_Model_Quote::PAYMENT_TYPE_PARTIAL_PAYMENT_SIGNATURE)):?>
            <?php $displayPartialPercentagePaymentNotificationClass = '';?>
        <?php endif;?>

        <?php $displayPartialPaymentClass = 'hidden';?>
        <?php $enabledPartialPayment = Models_Mapper_ShoppingConfig::getInstance()->getConfigParam('enabledPartialPayment');?>
        <?php if (!empty($enabledPartialPayment)):?>
            <?php $displayPartialPaymentClass = '';?>
        <?php endif;?>

        <?php $disableAutosaveEmailClass = 'hidden';?>
        <?php $disableAutosaveEmail = Models_Mapper_ShoppingConfig::getInstance()->getConfigParam('allowAutosave');?>
        <?php if (!empty($disableAutosaveEmail)):?>
            <?php $disableAutosaveEmailClass = '';?>
        <?php endif;?>

        <p>
            <?php echo $this->form->getElement('autoQuote')->renderLabel(); ?>
            <?php echo $this->form->getElement('autoQuote')->renderViewHelper(); ?>
        </p>
        <p>
            <?php echo $this->form->getElement('quoteTemplate')->renderLabel(); ?>
            <?php echo $this->form->getElement('quoteTemplate')->renderViewHelper(); ?>
        </p>
        <p>
            <?php echo $this->form->getElement('expirationDelay')->renderLabel(); ?>
            <?php echo $this->form->getElement('expirationDelay')->renderViewHelper(); ?>
        </p>
<!--        <p>-->
<!--            --><?php //echo $this->form->getElement('defaultQuoteCreatorId')->renderLabel(); ?>
<!--            --><?php //echo $this->form->getElement('defaultQuoteCreatorId')->renderViewHelper(); ?>
<!--        </p>-->
        <fieldset class="background">
            <p>
                <?php echo $this->form->getElement('allowAutosave')->renderLabel(); ?>
                <?php echo $this->form->getElement('allowAutosave')->renderViewHelper(); ?>
            </p>

            <p id="disable-autosave-email-block" class="mb10px <?php echo $disableAutosaveEmailClass;?>">
                <?php echo $this->form->getElement('disableAutosaveEmail')->renderLabel(); ?>
                <?php echo $this->form->getElement('disableAutosaveEmail')->renderViewHelper(); ?>
            </p>
        </fieldset>
        <p>
            <?php echo $this->form->getElement('quoteDraggableProducts')->renderLabel(); ?>
            <?php echo $this->form->getElement('quoteDraggableProducts')->renderViewHelper(); ?>
        </p>
        <fieldset class="background">
            <p>
                <?php echo $this->form->getElement('enabledPartialPayment')->renderLabel(); ?>
                <?php echo $this->form->getElement('enabledPartialPayment')->renderViewHelper(); ?>
            </p>
            <div id="partial-notify-block" class="<?php echo $displayPartialPaymentClass;?>">
                <span class="grid_12"><?php echo $this->translate('Send payment complement request automatically after');?>:<a href="javascript:;" target="_blank" class="ticon-info tooltip icon18" title="<?php echo $this->translate('Create templates from the action e-mails & SMS screens');?>"></a></span>
                <p class="grid_6 mb10px">
                    <?php echo $this->form->getElement('partialNotifyAfterQuantity')->renderViewHelper(); ?>
                </p>
                <p class="grid_6 mb10px">
                    <?php echo $this->form->getElement('partialNotifyAfterType')->renderViewHelper(); ?>
                </p>
            </div>
        </fieldset>

        <fieldset id="quote-default-type-block" class="background mt5px">
                <p>
                    <?php echo $this->form->getElement('enableQuoteDefaultType')->renderLabel(); ?>
                    <?php echo $this->form->getElement('enableQuoteDefaultType')->renderViewHelper(); ?>
                </p>
                <p id="quote-payment-type-block" class="<?php echo $displayPartialPaymentNotificationClass;?>">
                    <?php echo $this->form->getElement('quotePaymentType')->addDecorator('Label', array('class' => 'grid_5'))->renderLabel(); ?>
                    <a href="javascript:;" target="_blank" class="ticon-info tooltip icon18 grid_1" title="<?php echo $this->translate("To activate partial options please turn on 'Accept partial payments for quote'");?>"></a>
                    <?php echo $this->form->getElement('quotePaymentType')->renderViewHelper(); ?>
                </p>
                <p id="quote-payment-type-percentage-block" class="<?php echo $displayPartialPercentagePaymentNotificationClass;?>">
                    <?php echo $this->form->getElement('quotePartialPercentage')->renderLabel(); ?>
                    <?php echo $this->form->getElement('quotePartialPercentage')->renderViewHelper(); ?>
                    <?php echo $this->form->getElement('quotePartialType')->renderViewHelper(); ?>
                </p>
        </fieldset>
        <p id="quote-download-label-block">
            <?php echo $this->form->getElement('quoteDownloadLabel')->renderLabel(); ?>
            <?php echo $this->form->getElement('quoteDownloadLabel')->renderViewHelper(); ?>
        </p>
        <p id="maximum-products-in-quote-block">
            <?php echo $this->form->getElement('maxProductsInQuote')->renderLabel(); ?>
            <?php echo $this->form->getElement('maxProductsInQuote')->renderViewHelper(); ?>
        </p>

        <p>
            <?php echo $this->form->getElement('applySettings')->renderViewHelper(); ?>
        </p>
    </form>
    <input type="hidden" class="quote-secure-token" name="<?php echo Tools_System_Tools::CSRF_SECURE_TOKEN;?>" value="<?php echo $this->secureToken;?>" />
</div>
<script type="text/javascript">
$(document).ready(function(){
    checkboxRadioStyle();

    $('#quote-payment-types').data('prev-option', $('#quote-payment-types').val());

    $(document).on('change', '#enable-quote-default-type', function () {
        if ($(this).is(':checked')) {
            $('#quote-payment-type-block').removeClass('hidden');
            $('#quote-payment-type-percentage-block').removeClass('hidden');

            var paymentType = $('#quote-payment-types').val();

            if(paymentType != 'partial_payment' && paymentType != 'partial_payment_signature') {
                $('#quote-payment-type-percentage-block').addClass('hidden');
            }
        } else {
            $('#quote-payment-type-block').addClass('hidden');
            $('#quote-payment-type-percentage-block').addClass('hidden');
        }
    });

    $(document).on('change', '#enabled-partial-payment', function () {
        var paymentType = $('#quote-payment-types').val();

        if ($(this).is(':checked')) {
            $('#partial-notify-block').removeClass('hidden');
        } else {
            $('#partial-notify-block').addClass('hidden');

            if(paymentType == 'partial_payment' || paymentType == 'partial_payment_signature') {
                $('#quote-payment-types').val('full_payment').trigger('change');
            }
        }
    });

    $(document).on('change', '#quote-payment-types', function () {
        var selectedOption = $(this).val(),
            prevSelectedOpt = $(this).data('prev-option');

        if (selectedOption === 'partial_payment' || selectedOption === 'partial_payment_signature') {
            var enabledPartialPaymentCheckbox = $('#enabled-partial-payment').is(':checked');

            if(!enabledPartialPaymentCheckbox) {
                $('#quote-payment-types').val(prevSelectedOpt);
                showMessage("<?php echo $this->translate('To activate this option please turn on \'Accept partial payments for quote\'');?>", true, 3000);
                return false;
            }

            $('#quote-payment-type-percentage-block').removeClass('hidden');
        } else {
            $('#quote-payment-type-percentage-block').addClass('hidden');
        }
        $('#quote-payment-types').data('prev-option', selectedOption);
    });

    $(document).on('change', '#allow-autosave-quote', function () {
        if ($(this).is(':checked')) {
            $('#disable-autosave-email-block').removeClass('hidden');
        } else {
            $('#disable-autosave-email-block').addClass('hidden');
            $('#disable-autosave-email').prop('checked', false);
        }
    });

    $(document).on("click", "#applySettings", function(e){
          e.preventDefault();
          var autoQuote = 0,
              draggableProducts = 0,
              enableQuoteDefaultType = 0,
              partialNotifyAfterType = $('#partial-notify-after-type').val(),
              partialNotifyAfterQuantity = $('#partial-notify-after-quantity').val(),
              enabledPartialPayment = 0,
              maxProductsInQuote = parseInt($('#max-products-in-quote').val()),
              allowAutosave = 0,
              disableAutosaveEmail = 0;
              // defaultQuoteCreatorId = '';

          if($('#auto-quote').prop("checked")){
              autoQuote = 1;
          }

          if($('#draggable-products').prop("checked")){
              draggableProducts = 1;
          }

          if($('#enable-quote-default-type').prop("checked")){
              enableQuoteDefaultType = 1;
          }

          if($('#enabled-partial-payment').prop("checked")){
              enabledPartialPayment = 1;
          }

        if($('#allow-autosave-quote').prop("checked")){
            allowAutosave = 1;
        }

        if($('#disable-autosave-email').prop("checked")){
            disableAutosaveEmail = 1;
        }

          $.ajax({
            type: "POST",
            url: '<?php echo $this->websiteUrl;?>plugin/quote/run/settings/',
            dataType: "json",
            data: {
                autoQuote: autoQuote,
                quoteDraggableProducts: draggableProducts,
                maxProductsInQuote:maxProductsInQuote,
                quoteTemplate: $('#quote-template option:selected').val(),
                expirationDelay: $('#expiration-delay').val(),
                enableQuoteDefaultType: enableQuoteDefaultType,
                quotePaymentType: $('#quote-payment-types').val(),
                quotePartialPercentage: $('#quote-partial-percentage').val(),
                quoteDownloadLabel: $('#quote-download-label').val(),
                enabledPartialPayment: enabledPartialPayment,
                partialNotifyAfterType: partialNotifyAfterType,
                partialNotifyAfterQuantity: partialNotifyAfterQuantity,
                quotePartialType: $('#quote-partial-type').val(),
                allowAutosave: allowAutosave,
                disableAutosaveEmail: disableAutosaveEmail,
                secureToken: $('.quote-secure-token').val(),
                //defaultQuoteCreatorId: $('#default-quote-creator-id').val()
            },
            success: function(responce){
                smoke.signal('<?php echo $this->translate('Saved');?>');
            }

          });
          return false;


     });


});
</script>
